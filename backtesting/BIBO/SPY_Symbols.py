import random
from datetime import datetime, timedelta

import pandas as pd
import pytz
import requests
from alpaca.data import StockBarsRequest, TimeFrame
from bs4 import BeautifulSoup

from account.authentication_paper import client
from account.authentication_paper import historicalClient



def get_sp500_symbols():
    url = "https://en.wikipedia.org/wiki/List_of_S%26P_500_companies"
    resp = requests.get(url)
    soup = BeautifulSoup(resp.text, "html.parser")
    table = soup.find("table", {"id": "constituents"})
    symbols = []
    for row in table.find_all("tr")[1:]:
        cols = row.find_all("td")
        symbol = cols[0].text.strip().replace(".", "-")
        symbols.append(symbol)

    symbols = [symbol for symbol in symbols if '-' not in symbol]
    symbols.remove("GOOG")

    print(symbols)
    print(len(symbols))

    end_date = datetime.now(pytz.UTC) - timedelta(days=1)
    start_date = end_date - timedelta(days=365)
    average_volumes = {}

    for symbol in symbols:

        req = StockBarsRequest(symbol_or_symbols=symbol, timeframe=TimeFrame.Day, start=start_date, end=end_date)
        bars = historicalClient.get_stock_bars(req)[symbol]

        total_volume = sum(bar.volume for bar in bars)
        average_volume = total_volume / len(bars) if bars else 0
        average_volumes[symbol] = average_volume

    return average_volumes


#spy = get_sp500_symbols()
spy = ['MMM', 'AOS', 'ABT', 'ABBV', 'ACN', 'ADBE', 'AMD', 'AES', 'AFL', 'A', 'APD', 'ABNB', 'AKAM', 'ALB', 'ARE', 'ALGN', 'ALLE', 'LNT', 'ALL', 'GOOGL', 'MO', 'AMZN', 'AMCR', 'AEE', 'AEP', 'AXP', 'AIG', 'AMT', 'AWK', 'AMP', 'AME', 'AMGN', 'APH', 'ADI', 'ANSS', 'AON', 'APA', 'APO', 'AAPL', 'AMAT', 'APTV', 'ACGL', 'ADM', 'ANET', 'AJG', 'AIZ', 'T', 'ATO', 'ADSK', 'ADP', 'AZO', 'AVB', 'AVY', 'AXON', 'BKR', 'BALL', 'BAC', 'BAX', 'BDX', 'BBY', 'TECH', 'BIIB', 'BLK', 'BX', 'BK', 'BA', 'BKNG', 'BSX', 'BMY', 'AVGO', 'BR', 'BRO', 'BLDR', 'BG', 'BXP', 'CHRW', 'CDNS', 'CZR', 'CPT', 'CPB', 'COF', 'CAH', 'KMX', 'CCL', 'CARR', 'CAT', 'CBOE', 'CBRE', 'CDW', 'COR', 'CNC', 'CNP', 'CF', 'CRL', 'SCHW', 'CHTR', 'CVX', 'CMG', 'CB', 'CHD', 'CI', 'CINF', 'CTAS', 'CSCO', 'C', 'CFG', 'CLX', 'CME', 'CMS', 'KO', 'CTSH', 'COIN', 'CL', 'CMCSA', 'CAG', 'COP', 'ED', 'STZ', 'CEG', 'COO', 'CPRT', 'GLW', 'CPAY', 'CTVA', 'CSGP', 'COST', 'CTRA', 'CRWD', 'CCI', 'CSX', 'CMI', 'CVS', 'DHR', 'DRI', 'DDOG', 'DVA', 'DAY', 'DECK', 'DE', 'DELL', 'DAL', 'DVN', 'DXCM', 'FANG', 'DLR', 'DG', 'DLTR', 'D', 'DPZ', 'DASH', 'DOV', 'DOW', 'DHI', 'DTE', 'DUK', 'DD', 'EMN', 'ETN', 'EBAY', 'ECL', 'EIX', 'EW', 'EA', 'ELV', 'EMR', 'ENPH', 'ETR', 'EOG', 'EPAM', 'EQT', 'EFX', 'EQIX', 'EQR', 'ERIE', 'ESS', 'EL', 'EG', 'EVRG', 'ES', 'EXC', 'EXE', 'EXPE', 'EXPD', 'EXR', 'XOM', 'FFIV', 'FDS', 'FICO', 'FAST', 'FRT', 'FDX', 'FIS', 'FITB', 'FSLR', 'FE', 'FI', 'F', 'FTNT', 'FTV', 'FOXA', 'FOX', 'BEN', 'FCX', 'GRMN', 'IT', 'GE', 'GEHC', 'GEV', 'GEN', 'GNRC', 'GD', 'GIS', 'GM', 'GPC', 'GILD', 'GPN', 'GL', 'GDDY', 'GS', 'HAL', 'HIG', 'HAS', 'HCA', 'DOC', 'HSIC', 'HSY', 'HES', 'HPE', 'HLT', 'HOLX', 'HD', 'HON', 'HRL', 'HST', 'HWM', 'HPQ', 'HUBB', 'HUM', 'HBAN', 'HII', 'IBM', 'IEX', 'IDXX', 'ITW', 'INCY', 'IR', 'PODD', 'INTC', 'ICE', 'IFF', 'IP', 'IPG', 'INTU', 'ISRG', 'IVZ', 'INVH', 'IQV', 'IRM', 'JBHT', 'JBL', 'JKHY', 'J', 'JNJ', 'JCI', 'JPM', 'K', 'KVUE', 'KDP', 'KEY', 'KEYS', 'KMB', 'KIM', 'KMI', 'KKR', 'KLAC', 'KHC', 'KR', 'LHX', 'LH', 'LRCX', 'LW', 'LVS', 'LDOS', 'LEN', 'LII', 'LLY', 'LIN', 'LYV', 'LKQ', 'LMT', 'L', 'LOW', 'LULU', 'LYB', 'MTB', 'MPC', 'MKTX', 'MAR', 'MMC', 'MLM', 'MAS', 'MA', 'MTCH', 'MKC', 'MCD', 'MCK', 'MDT', 'MRK', 'META', 'MET', 'MTD', 'MGM', 'MCHP', 'MU', 'MSFT', 'MAA', 'MRNA', 'MHK', 'MOH', 'TAP', 'MDLZ', 'MPWR', 'MNST', 'MCO', 'MS', 'MOS', 'MSI', 'MSCI', 'NDAQ', 'NTAP', 'NFLX', 'NEM', 'NWSA', 'NWS', 'NEE', 'NKE', 'NI', 'NDSN', 'NSC', 'NTRS', 'NOC', 'NCLH', 'NRG', 'NUE', 'NVDA', 'NVR', 'NXPI', 'ORLY', 'OXY', 'ODFL', 'OMC', 'ON', 'OKE', 'ORCL', 'OTIS', 'PCAR', 'PKG', 'PLTR', 'PANW', 'PARA', 'PH', 'PAYX', 'PAYC', 'PYPL', 'PNR', 'PEP', 'PFE', 'PCG', 'PM', 'PSX', 'PNW', 'PNC', 'POOL', 'PPG', 'PPL', 'PFG', 'PG', 'PGR', 'PLD', 'PRU', 'PEG', 'PTC', 'PSA', 'PHM', 'PWR', 'QCOM', 'DGX', 'RL', 'RJF', 'RTX', 'O', 'REG', 'REGN', 'RF', 'RSG', 'RMD', 'RVTY', 'ROK', 'ROL', 'ROP', 'ROST', 'RCL', 'SPGI', 'CRM', 'SBAC', 'SLB', 'STX', 'SRE', 'NOW', 'SHW', 'SPG', 'SWKS', 'SJM', 'SW', 'SNA', 'SOLV', 'SO', 'LUV', 'SWK', 'SBUX', 'STT', 'STLD', 'STE', 'SYK', 'SMCI', 'SYF', 'SNPS', 'SYY', 'TMUS', 'TROW', 'TTWO', 'TPR', 'TRGP', 'TGT', 'TEL', 'TDY', 'TER', 'TSLA', 'TXN', 'TPL', 'TXT', 'TMO', 'TJX', 'TKO', 'TSCO', 'TT', 'TDG', 'TRV', 'TRMB', 'TFC', 'TYL', 'TSN', 'USB', 'UBER', 'UDR', 'ULTA', 'UNP', 'UAL', 'UPS', 'URI', 'UNH', 'UHS', 'VLO', 'VTR', 'VLTO', 'VRSN', 'VRSK', 'VZ', 'VRTX', 'VTRS', 'VICI', 'V', 'VST', 'VMC', 'WRB', 'GWW', 'WAB', 'WBA', 'WMT', 'DIS', 'WBD', 'WM', 'WAT', 'WEC', 'WFC', 'WELL', 'WST', 'WDC', 'WY', 'WSM', 'WMB', 'WTW', 'WDAY', 'WYNN', 'XEL', 'XYL', 'YUM', 'ZBRA', 'ZBH', 'ZTS']
spy_volumes = {'MMM': 3801607.828, 'AOS': 1302558.404, 'ABT': 6153908.812, 'ABBV': 6307797.4, 'ACN': 2924728.8, 'ADBE': 3458119.732, 'AMD': 41794517.508, 'AES': 13795962.484, 'AFL': 2152736.156, 'A': 1845973.56, 'APD': 1360779.536, 'ABNB': 5030916.604, 'AKAM': 2078044.732, 'ALB': 2881341.036, 'ARE': 1393001.34, 'ALGN': 919944.164, 'ALLE': 872154.92, 'LNT': 1727952.148, 'ALL': 1640520.704, 'GOOGL': 31900106.912, 'MO': 8665025.884, 'AMZN': 42108349.2, 'AMCR': 21144698.388, 'AEE': 1577664.988, 'AEP': 3227591.488, 'AXP': 2848553.472, 'AIG': 4366283.384, 'AMT': 2503740.364, 'AWK': 1238482.268, 'AMP': 496940.84, 'AME': 1303874.14, 'AMGN': 2845962.964, 'APH': 7679181.024, 'ADI': 3602955.508, 'ANSS': 529011.208, 'AON': 1166192.612, 'APA': 7247494.216, 'APO': 3948044.172, 'AAPL': 53386892.16, 'AMAT': 7109592.372, 'APTV': 3386987.176, 'ACGL': 1737966.004, 'ADM': 3497727.372, 'ANET': 6851990.088, 'AJG': 1386295.58, 'AIZ': 428041.492, 'T': 36517934.18, 'ATO': 914403.044, 'ADSK': 1504172.92, 'ADP': 1711329.032, 'AZO': 130757.076, 'AVB': 745503.472, 'AVY': 650312.808, 'AXON': 728637.252, 'BKR': 7193012.672, 'BALL': 2220671.98, 'BAC': 40529864.416, 'BAX': 4371255.732, 'BDX': 2078517.604, 'BBY': 3337278.424, 'TECH': 1471165.976, 'BIIB': 1448218.256, 'BLK': 693768.212, 'BX': 3888704.868, 'BK': 4138750.528, 'BA': 9546604.764, 'BKNG': 249079.112, 'BSX': 6701181.48, 'BMY': 12846328.268, 'AVGO': 28027015.456, 'BR': 528342.34, 'BRO': 1890225.376, 'BLDR': 1723569.58, 'BG': 1707981.104, 'BXP': 1347138.784, 'CHRW': 1295874.396, 'CDNS': 2036192.924, 'CZR': 4982434.244, 'CPT': 951825.4, 'CPB': 3211983.36, 'COF': 3624285.152, 'CAH': 2240181.792, 'KMX': 2407008.424, 'CCL': 25243344.94, 'CARR': 4695090.556, 'CAT': 2530243.7, 'CBOE': 875293.964, 'CBRE': 1815785.912, 'CDW': 1237152.336, 'COR': 1509967.872, 'CNC': 5764375.94, 'CNP': 5628009.736, 'CF': 2247357.692, 'CRL': 1032048.0, 'SCHW': 9588896.676, 'CHTR': 1267203.56, 'CVX': 8352129.556, 'CMG': 12696616.736, 'CB': 1644723.04, 'CHD': 1764374.44, 'CI': 1739076.34, 'CINF': 649534.96, 'CTAS': 1468828.272, 'CSCO': 20364864.836, 'C': 14620138.368, 'CFG': 4846561.22, 'CLX': 1411328.552, 'CME': 2185012.188, 'CMS': 2331179.568, 'KO': 16313634.464, 'CTSH': 3551985.532, 'COIN': 10925233.224, 'CL': 4849731.88, 'CMCSA': 21974484.524, 'CAG': 5963518.764, 'COP': 7648345.176, 'ED': 2407117.752, 'STZ': 1922573.62, 'CEG': 3656740.024, 'COO': 1741653.696, 'CPRT': 4919173.996, 'GLW': 5377919.732, 'CPAY': 473781.956, 'CTVA': 3431172.66, 'CSGP': 2900888.12, 'COST': 2068103.688, 'CTRA': 6543067.896, 'CRWD': 4772361.344, 'CCI': 2933962.592, 'CSX': 13377061.396, 'CMI': 775524.32, 'CVS': 10798366.752, 'DHR': 3504225.78, 'DRI': 1344088.76, 'DDOG': 4986958.2, 'DVA': 812102.804, 'DAY': 1758832.308, 'DECK': 2335496.04, 'DE': 1346554.808, 'DELL': 8618771.416, 'DAL': 9958617.584, 'DVN': 8875248.596, 'DXCM': 4425253.22, 'FANG': 2292166.812, 'DLR': 2017214.036, 'DG': 4118705.7, 'DLTR': 4229941.636, 'D': 4780408.04, 'DPZ': 640939.532, 'DASH': 4235818.524, 'DOV': 953631.348, 'DOW': 7561015.572, 'DHI': 3166537.496, 'DTE': 1297976.636, 'DUK': 3474900.376, 'DD': 2455650.616, 'EMN': 1246414.232, 'ETN': 2670015.512, 'EBAY': 5051844.376, 'ECL': 1180509.036, 'EIX': 3375241.488, 'EW': 5258390.048, 'EA': 2813645.788, 'ELV': 1631197.076, 'EMR': 3007290.644, 'ENPH': 5022078.952, 'ETR': 2813473.376, 'EOG': 3410659.308, 'EPAM': 687397.224, 'EQT': 8042245.776, 'EFX': 990245.06, 'EQIX': 562754.276, 'EQR': 1769446.864, 'ERIE': 158443.544, 'ESS': 425832.628, 'EL': 4312430.568, 'EG': 404989.868, 'EVRG': 2082153.076, 'ES': 2492397.992, 'EXC': 7098344.624, 'EXE': 3115195.98, 'EXPE': 1901133.528, 'EXPD': 1248704.344, 'EXR': 1070639.064, 'XOM': 15800195.992, 'FFIV': 563566.372, 'FDS': 293981.572, 'FICO': 203770.336, 'FAST': 3383062.064, 'FRT': 716242.244, 'FDX': 1859993.292, 'FIS': 3366951.212, 'FITB': 4574684.42, 'FSLR': 3260070.192, 'FE': 3999242.956, 'FI': 3393422.404, 'F': 83328749.944, 'FTNT': 4876991.096, 'FTV': 2800031.928, 'FOXA': 3621379.436, 'FOX': 1128775.56, 'BEN': 4517722.136, 'FCX': 13796375.328, 'GRMN': 908358.116, 'IT': 511679.968, 'GE': 5549868.812, 'GEHC': 3531305.704, 'GEV': 3319573.256, 'GEN': 3748226.288, 'GNRC': 864956.22, 'GD': 1399580.42, 'GIS': 4704553.912, 'GM': 12702592.648, 'GPC': 1303512.6, 'GILD': 7693128.832, 'GPN': 2506660.512, 'GL': 709599.696, 'GDDY': 1337203.328, 'GS': 2390623.696, 'HAL': 11547949.016, 'HIG': 1592508.98, 'HAS': 1741801.136, 'HCA': 1459864.544, 'DOC': 5350509.648, 'HSIC': 1726334.476, 'HSY': 1806935.228, 'HES': 1842449.536, 'HPE': 17041258.292, 'HLT': 1790689.472, 'HOLX': 2388845.344, 'HD': 3436502.32, 'HON': 3857352.452, 'HRL': 2733121.024, 'HST': 8797104.968, 'HWM': 2809494.072, 'HPQ': 7956079.42, 'HUBB': 536189.968, 'HUM': 1815783.576, 'HBAN': 18971600.132, 'HII': 561644.976, 'IBM': 4240500.204, 'IEX': 603868.276, 'IDXX': 647314.032, 'ITW': 998411.552, 'INCY': 1951959.068, 'IR': 2589217.384, 'PODD': 720849.536, 'INTC': 86457669.816, 'ICE': 2974193.92, 'IFF': 1534158.992, 'IP': 5664058.28, 'IPG': 5909296.072, 'INTU': 1621402.508, 'ISRG': 1679936.676, 'IVZ': 4473164.208, 'INVH': 3400070.992, 'IQV': 1659089.42, 'IRM': 1785143.768, 'JBHT': 1001865.956, 'JBL': 1417811.684, 'JKHY': 570569.144, 'J': 800315.284, 'JNJ': 8068846.328, 'JCI': 4340637.68, 'JPM': 9560846.812, 'K': 3016596.028, 'KVUE': 16054884.4, 'KDP': 10965588.272, 'KEY': 13182141.732, 'KEYS': 1100837.552, 'KMB': 2211807.276, 'KIM': 4518156.276, 'KMI': 13963029.732, 'KKR': 4236214.3, 'KLAC': 1136320.984, 'KHC': 10360526.184, 'KR': 5893288.212, 'LHX': 1158473.112, 'LH': 647899.316, 'LRCX': 9518596.48, 'LW': 2654997.008, 'LVS': 5867324.584, 'LDOS': 1279245.212, 'LEN': 2694937.012, 'LII': 365076.004, 'LLY': 3672107.056, 'LIN': 1976140.62, 'LYV': 2345895.176, 'LKQ': 2309667.864, 'LMT': 1364816.928, 'L': 739714.568, 'LOW': 2496284.736, 'LULU': 2340925.648, 'LYB': 2969356.284, 'MTB': 1190938.884, 'MPC': 2717949.212, 'MKTX': 499413.032, 'MAR': 1590727.332, 'MMC': 1977722.108, 'MLM': 476671.356, 'MAS': 1832839.728, 'MA': 2666746.764, 'MTCH': 4788415.372, 'MKC': 2070473.492, 'MCD': 3534108.46, 'MCK': 925917.864, 'MDT': 7021796.956, 'MRK': 13421044.82, 'META': 14493910.896, 'MET': 3359105.272, 'MTD': 150352.68, 'MGM': 4955549.804, 'MCHP': 8943427.708, 'MU': 23253265.484, 'MSFT': 21675905.704, 'MAA': 804442.976, 'MRNA': 8858402.424, 'MHK': 767992.424, 'MOH': 717849.068, 'TAP': 2152808.728, 'MDLZ': 8101623.348, 'MPWR': 804527.392, 'MNST': 6004176.904, 'MCO': 766130.224, 'MS': 6679642.82, 'MOS': 4831413.92, 'MSI': 825802.796, 'MSCI': 508757.336, 'NDAQ': 3079116.648, 'NTAP': 1912936.472, 'NFLX': 3768026.112, 'NEM': 10645735.72, 'NWSA': 2937134.14, 'NWS': 729444.876, 'NEE': 11114018.848, 'NKE': 15241409.084, 'NI': 4133011.044, 'NDSN': 329988.568, 'NSC': 1237337.852, 'NTRS': 1445478.916, 'NOC': 878996.532, 'NCLH': 12968093.896, 'NRG': 2982848.324, 'NUE': 2242465.796, 'NVDA': 266171158.944, 'NVR': 22229.088, 'NXPI': 2767316.424, 'ORLY': 768138.736, 'OXY': 11891463.388, 'ODFL': 1651810.788, 'OMC': 2667316.716, 'ON': 8348787.084, 'OKE': 3475699.6, 'ORCL': 10260631.996, 'OTIS': 2320867.788, 'PCAR': 2731515.332, 'PKG': 747813.468, 'PLTR': 83125309.728, 'PANW': 4237334.88, 'PARA': 8839077.044, 'PH': 696143.104, 'PAYX': 1979294.832, 'PAYC': 664449.644, 'PYPL': 10875931.692, 'PNR': 1463837.06, 'PEP': 7081012.04, 'PFE': 41844880.944, 'PCG': 18670950.992, 'PM': 5635065.252, 'PSX': 3119309.804, 'PNW': 1138061.556, 'PNC': 2145956.236, 'POOL': 427630.424, 'PPG': 1858280.424, 'PPL': 4939466.78, 'PFG': 1320030.564, 'PG': 7601813.224, 'PGR': 2811595.936, 'PLD': 4184338.884, 'PRU': 1663053.988, 'PEG': 2771380.62, 'PTC': 930851.144, 'PSA': 761256.716, 'PHM': 2042689.964, 'PWR': 1180189.108, 'QCOM': 8535476.372, 'DGX': 994820.328, 'RL': 808010.788, 'RJF': 1326880.352, 'RTX': 5287586.2, 'O': 5253818.836, 'REG': 1066052.184, 'REGN': 915763.52, 'RF': 8358783.232, 'RSG': 1153118.936, 'RMD': 968993.844, 'RVTY': 976847.42, 'ROK': 865898.008, 'ROL': 1763365.708, 'ROP': 557517.184, 'ROST': 2814543.712, 'RCL': 2361847.348, 'SPGI': 1229041.964, 'CRM': 6542345.74, 'SBAC': 877027.928, 'SLB': 13871675.476, 'STX': 3243457.808, 'SRE': 3882061.76, 'NOW': 1483810.684, 'SHW': 1720501.728, 'SPG': 1547176.508, 'SWKS': 3035573.06, 'SJM': 1313867.028, 'SW': 4162805.536, 'SNA': 367476.58, 'SOLV': 1110451.152, 'SO': 4708212.8, 'LUV': 10281215.904, 'SWK': 2026397.504, 'SBUX': 10853597.372, 'STT': 2111678.272, 'STLD': 1533451.652, 'STE': 550648.924, 'SYK': 1352738.576, 'SMCI': 52429965.792, 'SYF': 3874995.496, 'SNPS': 1190846.42, 'SYY': 3237161.332, 'TMUS': 4105802.968, 'TROW': 1546843.556, 'TTWO': 1789007.876, 'TPR': 4381519.1, 'TRGP': 1842535.872, 'TGT': 6277433.832, 'TEL': 1712162.012, 'TDY': 272746.276, 'TER': 2771221.572, 'TSLA': 99885096.172, 'TXN': 6452959.4, 'TPL': 147301.732, 'TXT': 1274389.228, 'TMO': 1995459.324, 'TJX': 5202688.4, 'TKO': 1126828.596, 'TSCO': 3471996.412, 'TT': 1334900.304, 'TDG': 261805.74, 'TRV': 1287631.752, 'TRMB': 1404530.412, 'TFC': 8327410.668, 'TYL': 266257.392, 'TSN': 2458816.212, 'USB': 9409724.34, 'UBER': 21214291.868, 'UDR': 2180194.708, 'ULTA': 1043674.82, 'UNP': 2739912.604, 'UAL': 7719065.856, 'UPS': 5256095.108, 'URI': 587503.4, 'UNH': 7689368.864, 'UHS': 785634.404, 'VLO': 3085558.816, 'VTR': 2910163.352, 'VLTO': 1402593.376, 'VRSN': 757781.328, 'VRSK': 780189.032, 'VZ': 20208937.208, 'VRTX': 1424282.368, 'VTRS': 10974734.604, 'VICI': 5931578.476, 'V': 6823953.536, 'VST': 7168617.644, 'VMC': 984579.148, 'WRB': 1795270.084, 'GWW': 250643.384, 'WAB': 1066534.444, 'WBA': 19356429.476, 'WMT': 18115422.548, 'DIS': 10013460.616, 'WBD': 36978363.484, 'WM': 1634174.688, 'WAT': 472613.172, 'WEC': 2153311.324, 'WFC': 17417196.488, 'WELL': 2906123.148, 'WST': 737093.088, 'WDC': 6614804.516, 'WY': 3851095.0, 'WSM': 1968291.02, 'WMB': 7104820.456, 'WTW': 612157.144, 'WDAY': 2483344.476, 'WYNN': 2603961.724, 'XEL': 3598657.676, 'XYL': 1418464.872, 'YUM': 1997695.756, 'ZBRA': 483014.888, 'ZBH': 1825459.028, 'ZTS': 2591232.82}
spy_volumes_sorted = dict(sorted(spy_volumes.items(), key=lambda item: item[1], reverse=True))

print(spy)
print(random.shuffle(spy))
print(spy_volumes)
print(spy_volumes_sorted)

spy_sorted = list(spy_volumes_sorted.keys())[:500]

print(len(spy_sorted))
print(spy_sorted)


